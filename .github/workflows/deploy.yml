name: Deploy to Docker host via SSH

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Debug repo contents (for scp)
        run: |
          echo "PWD: $(pwd)"
          echo "Listing root:"; ls -la
          echo "Listing app/:"; ls -la app || true

      - name: Create tarball of artifacts for upload
        run: |
          set -e
          TARFILE="release-$(date +%s).tar.gz"
          echo "Creating $TARFILE"
          # Create tar with explicit paths so we control behavior
          tar -czf "$TARFILE" docker-compose.yml app
          ls -la "$TARFILE"
          echo "TARFILE=$TARFILE" >> $GITHUB_ENV

      - name: Write and verify SSH key setup
        run: |
          if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            echo "ERROR: SSH_PRIVATE_KEY secret is empty" && exit 1
          fi
          mkdir -p ~/.ssh
          echo "Writing SSH key to /tmp/deploy_key"
          printf '%s' "${{ secrets.SSH_PRIVATE_KEY }}" > /tmp/deploy_key
          chmod 600 /tmp/deploy_key
          ls -la /tmp/deploy_key
          # Test SSH connection and create target directory
          echo "Testing SSH connection and creating target directory"
          ssh -i /tmp/deploy_key -o StrictHostKeyChecking=no -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "mkdir -p ${{ secrets.REMOTE_PATH }}"
          echo "SSH_KEY_PATH=/tmp/deploy_key" >> $GITHUB_ENV

      - name: Upload tarball to remote host
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key_path: ${{ env.SSH_KEY_PATH }}
          port: ${{ secrets.SSH_PORT }}
          source: ${{ env.TARFILE }}
          target: ${{ secrets.REMOTE_PATH }}
          debug: true

      - name: Run docker compose on remote
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            set -e
            cd "${{ secrets.REMOTE_PATH }}"
            # Ensure docker is available
            docker --version
            # Extract uploaded tarball (find the most recent release-*.tar.gz)
            TARFILE=$(ls -1t release-*.tar.gz 2>/dev/null | head -n1 || true)
            if [ -n "$TARFILE" ]; then
              echo "Extracting $TARFILE"
              tar -xzf "$TARFILE"
              rm -f "$TARFILE"
            else
              echo "No tarfile found to extract"
            fi
            # Use docker compose (v2) if available, fallback to docker-compose
            if command -v docker-compose >/dev/null 2>&1; then
              docker-compose pull || true
              docker-compose up -d --build
            else
              docker compose pull || true
              docker compose up -d --build
            fi
