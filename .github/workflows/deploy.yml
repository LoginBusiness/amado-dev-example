name: Deploy to Docker host via SSH

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Debug repo contents (for scp)
        run: |
          echo "PWD: $(pwd)"
          echo "Listing root:"; ls -la
          echo "Listing app/:"; ls -la app || true

      - name: Create tarball of artifacts for upload
        run: |
          set -e
          TARFILE="release-$(date +%s).tar.gz"
          echo "Creating $TARFILE"
          # Create tar with explicit paths so we control behavior
          tar -czf "$TARFILE" docker-compose.yml app
          ls -la "$TARFILE"
          echo "TARFILE=$TARFILE" >> $GITHUB_ENV

      - name: Write and verify SSH key setup
        run: |
          if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            echo "ERROR: SSH_PRIVATE_KEY secret is empty" && exit 1
          fi
          mkdir -p ~/.ssh
          echo "Writing SSH key to /tmp/deploy_key"
          printf '%s' "${{ secrets.SSH_PRIVATE_KEY }}" > /tmp/deploy_key
          chmod 600 /tmp/deploy_key
          ls -la /tmp/deploy_key
          
          # Setup known hosts to prevent host key verification issues
          ssh-keyscan -p ${{ secrets.SSH_PORT }} -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts
          
          # Test SSH connection with forced public key auth and specific key type
          echo "Testing SSH connection and creating target directory"
          ssh -i /tmp/deploy_key \
              -o PreferredAuthentications=publickey \
              -o PubkeyAuthentication=yes \
              -o PasswordAuthentication=no \
              -o HostKeyAlgorithms=ssh-ed25519 \
              -o PubkeyAcceptedKeyTypes=ssh-ed25519 \
              -vvv \
              -p ${{ secrets.SSH_PORT }} \
              ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "mkdir -p ${{ secrets.REMOTE_PATH }}"
          
          echo "SSH_KEY_PATH=/tmp/deploy_key" >> $GITHUB_ENV

      - name: Upload tarball to remote host (using scp)
        run: |
          set -euo pipefail
          echo "Uploading $TARFILE to remote host using scp (runner scp binary)"
          # Ensure remote path exists (created earlier during SSH test, but be safe)
          ssh -i /tmp/deploy_key \
            -o IdentitiesOnly=yes \
            -o PreferredAuthentications=publickey \
            -o PubkeyAuthentication=yes \
            -o PasswordAuthentication=no \
            -o HostKeyAlgorithms=ssh-ed25519 \
            -o PubkeyAcceptedKeyTypes=ssh-ed25519 \
            -vvv \
            -p ${{ secrets.SSH_PORT }} \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "mkdir -p '${{ secrets.REMOTE_PATH }}'"

          # Copy the tarball (use scp with explicit options)
          scp -i /tmp/deploy_key \
            -o IdentitiesOnly=yes \
            -o PreferredAuthentications=publickey \
            -o PubkeyAuthentication=yes \
            -o PasswordAuthentication=no \
            -o HostKeyAlgorithms=ssh-ed25519 \
            -o PubkeyAcceptedKeyTypes=ssh-ed25519 \
            -vvv \
            -P ${{ secrets.SSH_PORT }} "${{ env.TARFILE }}" "${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ secrets.REMOTE_PATH }}/"

      - name: Run docker compose on remote (using ssh)
        run: |
          set -euo pipefail
          echo "Connecting to remote and running docker compose"
          ssh -i /tmp/deploy_key \
            -o IdentitiesOnly=yes \
            -o PreferredAuthentications=publickey \
            -o PubkeyAuthentication=yes \
            -o PasswordAuthentication=no \
            -o HostKeyAlgorithms=ssh-ed25519 \
            -o PubkeyAcceptedKeyTypes=ssh-ed25519 \
            -vvv \
            -p ${{ secrets.SSH_PORT }} \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            set -e
            cd "${{ secrets.REMOTE_PATH }}"
            docker --version
            TARFILE=$(ls -1t release-*.tar.gz 2>/dev/null | head -n1 || true)
            if [ -n "$TARFILE" ]; then
              echo "Extracting $TARFILE"
              tar -xzf "$TARFILE"
              rm -f "$TARFILE"
            else
              echo "No tarfile found to extract"
            fi
            if command -v docker-compose >/dev/null 2>&1; then
              docker-compose pull || true
              docker-compose up -d --build
            else
              docker compose pull || true
              docker compose up -d --build
            fi
          EOF
