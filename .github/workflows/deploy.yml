# This workflow deploys your application to a remote server via SSH
# when you push to the 'main' branch.

name: Deploy to Production

on:
  push:
    branches:
      - main # Triggers on push to the main branch

jobs:
  deploy:
    name: Deploy Application
    runs-on: ubuntu-latest # Use the latest Ubuntu runner

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        # This step checks out your repository's code so the action can access it.

      - name: Copy files to remote server
        uses: appleboy/scp-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          source: "docker-compose.yml,app/" # Files and directories to copy
          target: ${{ secrets.REMOTE_PATH }} # Destination path on the server
          overwrite: true # Overwrite existing files on the server
          debug: true # Enable debug output for troubleshooting

      - name: Run deployment commands on remote
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            # Navigate to the application directory on the server
            cd ${{ secrets.REMOTE_PATH }}
            
            echo "Current directory: $(pwd)"
            echo "Listing files..."
            ls -la
            
            echo "Pulling latest images (if any)..."
            docker-compose pull
            
            echo "Building and starting containers in detached mode..."
            # --build flag rebuilds services if their source code has changed
            docker-compose up -d --build
            
            echo "Cleaning up old Docker objects..."
            # -f flag forces pruning without confirmation
            docker system prune -f
            
            echo "Deployment complete."